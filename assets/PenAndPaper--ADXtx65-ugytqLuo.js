
/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * https://fantastic-admin.hurui.me
 */
    
import{e as v,J as ke,K as Y,c as Z,A as _,aa as ve,E as xe,aw as Ce,o as ee,f as E,w as ce,r as S,g as B,O as y,h as Ee,j as M,k as V,t as $e,u as Le,n as J,ak as de}from"./index-CJB5jCfL.js";import{b as Re,O as I,F as Se}from"./vue-data-ui-8Gmf-dDN.js";import{k as Be}from"./ColorPicker-BYn8PF2Z-DkxHqz9_.js";import"./alert-I_0TAljB.js";import"./vClickOutside-C6WiFswA-B2BXHGcD.js";const Ne={class:"vue-ui-pen-and-paper-action",style:{padding:"0 !important"}},Fe=["disabled"],Ke={__name:"PenAndPaper",props:{svgRef:{type:[Object,null,void 0],required:!0},color:{type:String,default:"#2D353C"},backgroundColor:{type:String,default:"#FFFFFF"},active:{type:Boolean,default:!1},scale:{type:Number,default:1}},emits:["close"],setup(d,{emit:pe}){const n=d,fe=pe,w=v([]),k=v([]),$=v(n.color),N=v(2),K=v(!1),U=v(""),u=v(null),b=v(null),G=v(null),m=v("draw"),T=v(!1),p=v(null),W=v({x:0,y:0}),F=v([""]),Q=v({row:0,col:0}),L=v(16),D=v(!1),te=v("url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAABg2lDQ1BJQ0MgcHJvZmlsZQAAKJF9kT1Iw0AcxV9TpSIVh2YQcchQnSyIijhKFYtgobQVWnUwufQLmjQkKS6OgmvBwY/FqoOLs64OroIg+AHi6OSk6CIl/i8ptIjx4Lgf7+497t4BQrPKNKtnAtB020wn4lIuvyqFXhGGiAhCiMnMMpKZxSx8x9c9Any9i/Es/3N/jgG1YDEgIBHPMcO0iTeIZzZtg/M+scjKskp8Tjxu0gWJH7muePzGueSywDNFM5ueJxaJpVIXK13MyqZGPE0cVTWd8oWcxyrnLc5atc7a9+QvDBf0lQzXaY4ggSUkkYIEBXVUUIWNGK06KRbStB/38Q+7/hS5FHJVwMixgBo0yK4f/A9+d2sVpya9pHAc6H1xnI9RILQLtBqO833sOK0TIPgMXOkdf60JzH6S3uho0SNgcBu4uO5oyh5wuQMMPRmyKbtSkKZQLALvZ/RNeSByC/Sveb2193H6AGSpq+Ub4OAQGCtR9rrPu/u6e/v3TLu/H5C7crM1WjgWAAAABmJLR0QAqwB5AHWF+8OUAAAACXBIWXMAAC4jAAAuIwF4pT92AAAAB3RJTUUH5gwUExIUagzGcQAAABl0RVh0Q29tbWVudABDcmVhdGVkIHdpdGggR0lNUFeBDhcAAABfSURBVBjTldAxDoNQDIPhL0+q1L33P1AvAhN7xfK6WAgoLfSfrNiykpQtE+7RLzx2vgF9D3o8lWDmn1QVVMP0LZQGmNtqp1/cmou0XHdG/+sYeGZwFBqPCub8rkcvvAGvsi1VYarR8wAAAABJRU5ErkJggg==') 5 5, auto");function ae(a){if(!u.value||m.value!=="text"||T.value)return;const{x:e,y:l}=H(a);W.value={x:e,y:l},F.value=[""],Q.value={row:0,col:0},D.value=!1;const t=document.createElementNS("http://www.w3.org/2000/svg","text");t.setAttribute("x",e),t.setAttribute("y",l),t.setAttribute("fill",$.value),t.setAttribute("font-size",L.value*n.scale),t.setAttribute("font-family","sans-serif"),t.setAttribute("class","vue-data-ui-doodle"),t.setAttribute("dominant-baseline","hanging"),t.setAttribute("pointer-events","all");const o=document.createElementNS("http://www.w3.org/2000/svg","tspan");o.setAttribute("x",e),o.setAttribute("dy","0"),o.textContent="",t.appendChild(o),t.style.pointerEvents="none",t.style.userSelect="none",u.value.appendChild(t),p.value=t,T.value=!0,window.addEventListener("keydown",le),window.addEventListener("mousedown",ne,!0),oe(),ue()}function le(a){if(!T.value)return;let{row:e,col:l}=Q.value,t=F.value.slice(),o=!1;if(a.key==="Enter"){const r=t[e],s=r.slice(0,l),c=r.slice(l);t.splice(e,1,s,c),e+=1,l=0,o=!0,a.preventDefault()}else if(a.key==="Backspace"){if(l>0)t[e]=t[e].slice(0,l-1)+t[e].slice(l),l-=1,o=!0;else if(e>0){const r=t[e-1].length;t[e-1]+=t[e],t.splice(e,1),e-=1,l=r,o=!0}a.preventDefault()}else if(a.key==="Delete")l<t[e].length?(t[e]=t[e].slice(0,l)+t[e].slice(l+1),o=!0):e<t.length-1&&(t[e]+=t[e+1],t.splice(e+1,1),o=!0),a.preventDefault();else if(a.key==="ArrowLeft")l>0?l-=1:e>0&&(e-=1,l=t[e].length),o=!0,a.preventDefault();else if(a.key==="ArrowRight")l<t[e].length?l+=1:e<t.length-1&&(e+=1,l=0),o=!0,a.preventDefault();else if(a.key==="ArrowUp")e>0&&(e-=1,l=Math.min(l,t[e].length),o=!0),a.preventDefault();else if(a.key==="ArrowDown")e<t.length-1&&(e+=1,l=Math.min(l,t[e].length),o=!0),a.preventDefault();else if(a.key.length===1&&!a.ctrlKey&&!a.metaKey&&!a.altKey)t[e]=t[e].slice(0,l)+a.key+t[e].slice(l),l+=1,o=!0,a.preventDefault();else if(a.key==="Escape"){X(!0);return}else a.key==="Tab"&&a.preventDefault();o&&(F.value=t,Q.value={row:e,col:l},t.some(r=>r.length>0)&&!D.value&&p.value&&(w.value.push(p.value),k.value=[],D.value=!0),oe(),ue())}function oe(){const a=p.value,{x:e}=W.value;for(;a.firstChild;)a.removeChild(a.firstChild);F.value.forEach((l,t)=>{const o=document.createElementNS("http://www.w3.org/2000/svg","tspan");o.setAttribute("x",e),o.setAttribute("dy",t===0?"0":"".concat(L.value*1.2*n.scale)),o.textContent=l.length?l:"​",a.appendChild(o)})}const P=v(null);function q(){P.value!==null&&(clearInterval(P.value),P.value=null)}function ge(a){q();let e=!0;a.style.opacity="1",P.value=setInterval(()=>{if(!u.value||!a||!u.value.contains(a)){q();return}e=!e,a.style.opacity=e?"1":"0"},500)}function ue(){var ie;const a=(ie=u.value)==null?void 0:ie.querySelector(".vue-data-ui-svg-caret");a&&u.value&&u.value.removeChild(a);const e=p.value;if(!e||!u.value)return;const{x:l,y:t}=W.value,{row:o,col:r}=Q.value,s=L.value*n.scale,c=e.childNodes[o];if(!c)return;let f=c.textContent.slice(0,r);f.endsWith(" ")&&(f+=" ");const i=document.createElementNS("http://www.w3.org/2000/svg","text");i.setAttribute("x",l),i.setAttribute("y",t),i.setAttribute("font-size",s),i.setAttribute("font-family","sans-serif"),i.textContent=f||"",u.value.appendChild(i);const A=i.getBBox();u.value.removeChild(i);const h=t+o*s*1.2,C=l+A.width,g=document.createElementNS("http://www.w3.org/2000/svg","rect");g.setAttribute("x",C),g.setAttribute("y",h),g.setAttribute("rx",1),g.setAttribute("width",2),g.setAttribute("height",s),g.setAttribute("fill",$.value),g.setAttribute("class","vue-data-ui-svg-caret"),u.value.appendChild(g),ge(g)}function ne(a){if(p.value&&!p.value.contains(a.target)){const e=p.value.children;e.length===1&&(e[0].textContent===""||e[0].textContent==="​")&&p.value.remove(),X(!1)}}function X(a=!1){var o,r;window.removeEventListener("keydown",le),window.removeEventListener("mousedown",ne,!0),q();const e=(o=u.value)==null?void 0:o.querySelector(".vue-data-ui-svg-caret");e&&u.value&&u.value.removeChild(e);const l=(r=p.value)==null?void 0:r.children;let t=!1;if(l&&l.length===1){const s=l[0].textContent;t=!s||s==="​"}(a||t)&&p.value&&u.value&&u.value.contains(p.value)&&u.value.removeChild(p.value),T.value=!1,p.value=null,F.value=[""],Q.value={row:0,col:0},D.value=!1}const x=ke(()=>Re(n.color,.6));function re(){if(!u.value)return;const a=u.value.querySelector(".vue-data-ui-mask");if(a&&u.value.removeChild(a),n.active){const e=document.createElementNS("http://www.w3.org/2000/svg","rect");e.setAttribute("class","vue-data-ui-mask"),e.setAttribute("width","100%"),e.setAttribute("height","100%"),e.setAttribute("fill","transparent"),e.setAttribute("pointer-events","all"),u.value.insertBefore(e,u.value.firstChild)}}function H(a){var o;const e=n.svgRef;if(!e)return{x:0,y:0};const l=e.createSVGPoint();l.x=a.clientX,l.y=a.clientY;const t=(o=e.getScreenCTM())==null?void 0:o.inverse();return t?l.matrixTransform(t):{x:0,y:0}}function me(a){const e=a.trim().split(/\s+/);if(e.length<4)return a;const l=e.slice(1).map(Number);if(l.length%2!==0)return a;const t=Ae(l),o=["M ".concat(t[0]," ").concat(t[1])];for(let c=2;c<t.length-2;c+=2){const f=t[c-2],i=t[c-1],A=t[c],h=t[c+1],C=(f+A)/2,g=(i+h)/2;o.push("Q ".concat(f," ").concat(i," ").concat(C," ").concat(g))}const r=t[t.length-2],s=t[t.length-1];return o.push("L ".concat(r," ").concat(s)),o.join(" ")}function Ae(a,e=1){const l=[...a];for(let t=2;t<a.length-2;t+=2){const o=a[t],r=a[t+1],s=a[t-2],c=a[t-1],f=a[t+2],i=a[t+3];l[t]=o+e*((s+f)/2-o),l[t+1]=r+e*((c+i)/2-r)}return l}function he(a){const e=a.trim().split(/\s+/);let l="",t="",o=null,r=null;for(let s=0;s<e.length;s+=1){const c=e[s];if(isNaN(c)){if(t=c,t==="M"||t==="L")o=parseFloat(e[++s]),r=parseFloat(e[++s]),l+="".concat(t).concat(o," ").concat(r);else if(t==="Q"){const f=parseFloat(e[++s]),i=parseFloat(e[++s]),A=parseFloat(e[++s]),h=parseFloat(e[++s]);f===o&&i===r?l+="t".concat(A-o," ").concat(h-r):l+="q".concat(f-o," ").concat(i-r," ").concat(A-o," ").concat(h-r),o=A,r=h}}else{const f=parseFloat(c),i=parseFloat(e[++s]);if(t==="L"){const A=f-o,h=i-r;A===0?l+="v".concat(h):h===0?l+="h".concat(A):l+="l".concat(A," ").concat(h),o=f,r=i}else if(t==="Q"){const A=f,h=i,C=parseFloat(e[++s]),g=parseFloat(e[++s]);A===o&&h===r?l+="t".concat(C-o," ").concat(g-r):l+="q".concat(A-o," ").concat(h-r," ").concat(C-o," ").concat(g-r),o=C,r=g}}}return l}function O(a){if(m.value!=="draw"||!n.active||!u.value)return;K.value=!0;const{x:e,y:l}=H(a);G.value={x:e,y:l},U.value="M ".concat(e," ").concat(l),b.value=document.createElementNS("http://www.w3.org/2000/svg","path"),b.value.setAttribute("stroke",$.value),b.value.setAttribute("stroke-width",N.value*n.scale),b.value.setAttribute("fill","none"),b.value.setAttribute("stroke-linecap","round"),b.value.setAttribute("stroke-linejoin","round"),b.value.setAttribute("class","vue-data-ui-doodle"),u.value.appendChild(b.value)}function j(a){if(!K.value||!u.value||!b.value)return;const{x:e,y:l}=H(a);U.value+=" ".concat(e," ").concat(l),b.value.setAttribute("d",U.value)}function R(a){if(K.value&&u.value&&b.value){const{x:e,y:l}=H(a);if(G.value&&G.value.x===e&&G.value.y===l){const t=document.createElementNS("http://www.w3.org/2000/svg","circle");t.setAttribute("cx",e),t.setAttribute("cy",l),t.setAttribute("r",N.value*n.scale/2),t.setAttribute("fill",$.value),t.setAttribute("class","vue-data-ui-doodle"),u.value.appendChild(t),w.value.push(t)}else{const t=b.value;t.setAttribute("d",he(me(U.value))),w.value.push(t)}k.value=[],b.value=""}K.value=!1}function be(){if(w.value.length>0){const a=w.value.pop();k.value.push(a),a===p.value?X(!0):u.value&&u.value.contains(a)&&u.value.removeChild(a)}}function we(){if(k.value.length>0){const a=k.value.pop();w.value.push(a),u.value&&u.value.appendChild(a)}}function ye(){u.value&&(u.value.innerHTML=""),w.value=[],k.value=[],D.value=!1,re()}Y(m,()=>{n.active&&(z(),se(),m.value==="text"?u.value.style.cursor="text":u.value.style.cursor=te.value)});function se(){!n.svgRef||!n.active||(m.value==="draw"?(n.svgRef.addEventListener("mousedown",O),n.svgRef.addEventListener("mousemove",j),n.svgRef.addEventListener("mouseup",R),n.svgRef.addEventListener("mouseleave",R),n.svgRef.addEventListener("touchstart",O,{passive:!1}),n.svgRef.addEventListener("touchmove",j,{passive:!1}),n.svgRef.addEventListener("touchend",R)):m.value==="text"&&n.svgRef.addEventListener("mousedown",ae),u.value&&(u.value.style.pointerEvents="auto"))}function z(){n.svgRef&&(n.svgRef.removeEventListener("mousedown",O),n.svgRef.removeEventListener("mousemove",j),n.svgRef.removeEventListener("mouseup",R),n.svgRef.removeEventListener("mouseleave",R),n.svgRef.removeEventListener("touchstart",O),n.svgRef.removeEventListener("touchmove",j),n.svgRef.removeEventListener("touchend",R),n.svgRef.removeEventListener("mousedown",ae),u.value&&(u.value.style.pointerEvents="none"))}return Y(()=>n.active,a=>{a?se():z()}),Y(()=>n.active,()=>{ve(()=>{re()})}),xe(()=>{ve(()=>{n.svgRef&&(u.value=document.createElementNS("http://www.w3.org/2000/svg","g"),u.value.setAttribute("class","vue-data-ui-doodles"),u.value.style.cursor=te.value,n.svgRef.appendChild(u.value),z())})}),Ce(()=>{q(),u.value&&n.svgRef&&(u.value.remove(),z())}),(a,e)=>d.active?(ee(),Z("div",{key:0,"data-dom-to-png-ignore":"",class:"vue-ui-pen-and-paper-actions",style:y({backgroundColor:d.backgroundColor})},[E("button",{class:"vue-ui-pen-and-paper-action",onClick:e[0]||(e[0]=l=>fe("close")),style:y({backgroundColor:d.backgroundColor,border:"1px solid ".concat(x.value)})},[S(a.$slots,"annotator-action-close",{},()=>[B(I,{name:"close",stroke:d.color},null,8,["stroke"])])],4),E("button",Ne,[B(Be,{value:$.value,"onUpdate:value":e[1]||(e[1]=l=>$.value=l),backgroundColor:d.backgroundColor,buttonBorderColor:x.value},{"annotator-action-color":Ee(({color:l})=>[S(a.$slots,"annotator-action-color",M(V({color:l})))]),_:3},8,["value","backgroundColor","buttonBorderColor"])]),E("button",{class:J(["vue-ui-pen-and-paper-action",{"vue-ui-pen-and-paper-action-active":m.value==="text"}]),onClick:e[2]||(e[2]=l=>m.value=m.value==="text"?"draw":"text"),style:y({backgroundColor:d.backgroundColor,border:"1px solid ".concat(x.value)})},[S(a.$slots,"annotator-action-draw",M(V({mode:m.value})),()=>[B(I,{name:m.value==="draw"?"annotator":"text",stroke:d.color},null,8,["name","stroke"])]),E("div",{style:y({position:"absolute",bottom:"-20px",color:x.value,width:"100%",textAlign:"center",fontSize:"12px",fontVariantNumeric:"tabular-nums"})},$e(Le(Se)({v:m.value==="draw"?N.value:L.value,s:"px",r:1})),5)],6),E("button",{class:J(["vue-ui-pen-and-paper-action",{"vue-ui-pen-and-paper-action-disabled":!w.value.length}]),disabled:!w.value.length,onClick:be,style:y({backgroundColor:d.backgroundColor,border:"1px solid ".concat(x.value),marginTop:"20px"})},[S(a.$slots,"annotator-action-undo",M(V({disabled:!w.value.length})),()=>[B(I,{name:"restart",stroke:d.color},null,8,["stroke"])])],14,Fe),E("button",{class:J(["vue-ui-pen-and-paper-action",{"vue-ui-pen-and-paper-action-disabled":!k.value.length}]),onClick:we,style:y({backgroundColor:d.backgroundColor,border:"1px solid ".concat(x.value)})},[S(a.$slots,"annotator-action-redo",M(V({disabled:!k.value.length})),()=>[B(I,{name:"restart",stroke:d.color,style:{transform:"scaleX(-1)"}},null,8,["stroke"])])],6),E("button",{class:J(["vue-ui-pen-and-paper-action",{"vue-ui-pen-and-paper-action-disabled":!w.value.length}]),onClick:ye,style:y({backgroundColor:d.backgroundColor,border:"1px solid ".concat(x.value)})},[S(a.$slots,"annotator-action-delete",M(V({disabled:!w.value.length})),()=>[B(I,{name:"trash",stroke:d.color},null,8,["stroke"])])],6),m.value==="draw"?ce((ee(),Z("input",{key:0,ref:"range",type:"range",class:"vertical-range",min:.5,max:12,step:.1,"onUpdate:modelValue":e[3]||(e[3]=l=>N.value=l),style:y({accentColor:d.color})},null,4)),[[de,N.value]]):_("",!0),m.value==="text"?ce((ee(),Z("input",{key:1,ref:"range",type:"range",class:"vertical-range",min:3,max:48,step:.1,"onUpdate:modelValue":e[4]||(e[4]=l=>L.value=l),style:y({accentColor:d.color})},null,4)),[[de,L.value]]):_("",!0)],4)):_("",!0)}};export{Ke as default};
