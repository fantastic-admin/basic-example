
/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * https://fantastic-admin.hurui.me
 */
    
import{e as c,J as fe,K as O,c as P,A as j,a9 as le,E as ge,av as me,o as J,f as C,w as ne,g as S,O as y,t as Ae,u as he,n as H,aj as ue}from"./index-DXZKKOp8.js";import{o as we,u as Q,f as be}from"./vue-data-ui-BN9YfUec.js";import{v as ye}from"./ColorPicker-J5wOPCeB-sgb_Bfch.js";import"./alert-l5XlVwCh.js";import"./vClickOutside-C6WiFswA-B2BXHGcD.js";const ke={class:"vue-ui-pen-and-paper-action",style:{padding:"0 !important"}},xe=["disabled"],Se={__name:"PenAndPaper",props:{svgRef:{type:[Object,null,void 0],required:!0},color:{type:String,default:"#2D353C"},backgroundColor:{type:String,default:"#FFFFFF"},active:{type:Boolean,default:!1},scale:{type:Number,default:1}},emits:["close"],setup(d,{emit:oe}){const o=d,re=oe,b=c([]),E=c([]),L=c(o.color),$=c(2),M=c(!1),D=c(""),u=c(null),A=c(null),V=c(null),h=c("draw"),K=c(!1),p=c(null),q=c({x:0,y:0}),N=c([""]),F=c({row:0,col:0}),B=c(16),W=c("url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAABg2lDQ1BJQ0MgcHJvZmlsZQAAKJF9kT1Iw0AcxV9TpSIVh2YQcchQnSyIijhKFYtgobQVWnUwufQLmjQkKS6OgmvBwY/FqoOLs64OroIg+AHi6OSk6CIl/i8ptIjx4Lgf7+497t4BQrPKNKtnAtB020wn4lIuvyqFXhGGiAhCiMnMMpKZxSx8x9c9Any9i/Es/3N/jgG1YDEgIBHPMcO0iTeIZzZtg/M+scjKskp8Tjxu0gWJH7muePzGueSywDNFM5ueJxaJpVIXK13MyqZGPE0cVTWd8oWcxyrnLc5atc7a9+QvDBf0lQzXaY4ggSUkkYIEBXVUUIWNGK06KRbStB/38Q+7/hS5FHJVwMixgBo0yK4f/A9+d2sVpya9pHAc6H1xnI9RILQLtBqO833sOK0TIPgMXOkdf60JzH6S3uho0SNgcBu4uO5oyh5wuQMMPRmyKbtSkKZQLALvZ/RNeSByC/Sveb2193H6AGSpq+Ub4OAQGCtR9rrPu/u6e/v3TLu/H5C7crM1WjgWAAAABmJLR0QAqwB5AHWF+8OUAAAACXBIWXMAAC4jAAAuIwF4pT92AAAAB3RJTUUH5gwUExIUagzGcQAAABl0RVh0Q29tbWVudABDcmVhdGVkIHdpdGggR0lNUFeBDhcAAABfSURBVBjTldAxDoNQDIPhL0+q1L33P1AvAhN7xfK6WAgoLfSfrNiykpQtE+7RLzx2vgF9D3o8lWDmn1QVVMP0LZQGmNtqp1/cmou0XHdG/+sYeGZwFBqPCub8rkcvvAGvsi1VYarR8wAAAABJRU5ErkJggg==') 5 5, auto");function z(l){if(!u.value||h.value!=="text"||K.value)return;const{x:e,y:a}=I(l);q.value={x:e,y:a},N.value=[""],F.value={row:0,col:0};const t=document.createElementNS("http://www.w3.org/2000/svg","text");t.setAttribute("x",e),t.setAttribute("y",a),t.setAttribute("fill",L.value),t.setAttribute("font-size",B.value*o.scale),t.setAttribute("font-family","sans-serif"),t.setAttribute("class","vue-data-ui-doodle"),t.setAttribute("dominant-baseline","hanging"),t.setAttribute("pointer-events","all");const n=document.createElementNS("http://www.w3.org/2000/svg","tspan");n.setAttribute("x",e),n.setAttribute("dy","0"),n.textContent="",t.appendChild(n),t.style.pointerEvents="none",t.style.userSelect="none",u.value.appendChild(t),p.value=t,K.value=!0,window.addEventListener("keydown",Z),window.addEventListener("mousedown",_,!0),X(),Y()}function Z(l){if(!K.value)return;let{row:e,col:a}=F.value,t=N.value.slice(),n=!1;if(l.key==="Enter"){const r=t[e],s=r.slice(0,a),v=r.slice(a);t.splice(e,1,s,v),e+=1,a=0,n=!0,l.preventDefault()}else if(l.key==="Backspace"){if(a>0)t[e]=t[e].slice(0,a-1)+t[e].slice(a),a-=1,n=!0;else if(e>0){const r=t[e-1].length;t[e-1]+=t[e],t.splice(e,1),e-=1,a=r,n=!0}l.preventDefault()}else if(l.key==="Delete")a<t[e].length?(t[e]=t[e].slice(0,a)+t[e].slice(a+1),n=!0):e<t.length-1&&(t[e]+=t[e+1],t.splice(e+1,1),n=!0),l.preventDefault();else if(l.key==="ArrowLeft")a>0?a-=1:e>0&&(e-=1,a=t[e].length),n=!0,l.preventDefault();else if(l.key==="ArrowRight")a<t[e].length?a+=1:e<t.length-1&&(e+=1,a=0),n=!0,l.preventDefault();else if(l.key==="ArrowUp")e>0&&(e-=1,a=Math.min(a,t[e].length),n=!0),l.preventDefault();else if(l.key==="ArrowDown")e<t.length-1&&(e+=1,a=Math.min(a,t[e].length),n=!0),l.preventDefault();else if(l.key.length===1&&!l.ctrlKey&&!l.metaKey&&!l.altKey)t[e]=t[e].slice(0,a)+l.key+t[e].slice(a),a+=1,n=!0,l.preventDefault();else if(l.key==="Escape"){ee(!0);return}else l.key==="Tab"&&l.preventDefault();n&&(N.value=t,F.value={row:e,col:a},X(),Y())}function X(){const l=p.value,{x:e}=q.value;for(;l.firstChild;)l.removeChild(l.firstChild);N.value.forEach((a,t)=>{const n=document.createElementNS("http://www.w3.org/2000/svg","tspan");n.setAttribute("x",e),n.setAttribute("dy",t===0?"0":"".concat(B.value*1.2*o.scale)),n.textContent=a.length?a:"​",l.appendChild(n)})}function Y(){const l=u.value.querySelector(".vue-data-ui-svg-caret");l&&u.value.removeChild(l);const e=p.value;if(!e)return;const{x:a,y:t}=q.value,{row:n,col:r}=F.value,s=B.value*o.scale,v=e.childNodes[n];if(!v)return;let f=v.textContent.slice(0,r);f.endsWith(" ")&&(f+=" ");const i=document.createElementNS("http://www.w3.org/2000/svg","text");i.setAttribute("x",a),i.setAttribute("y",t),i.setAttribute("font-size",s),i.setAttribute("font-family","sans-serif"),i.textContent=f||"",u.value.appendChild(i);const g=i.getBBox();u.value.removeChild(i);let m=t+n*s*1.2,x=a+g.width;const w=document.createElementNS("http://www.w3.org/2000/svg","rect");w.setAttribute("x",x),w.setAttribute("y",m),w.setAttribute("width",2),w.setAttribute("height",s),w.setAttribute("fill",L.value),w.setAttribute("class","vue-data-ui-svg-caret"),u.value.appendChild(w)}function _(l){if(p.value&&!p.value.contains(l.target)){const e=p.value.children;e.length===1&&(e[0].textContent===""||e[0].textContent==="​")&&p.value.remove(),ee(!1)}}function ee(l=!1){var n;window.removeEventListener("keydown",Z),window.removeEventListener("mousedown",_,!0);const e=u.value.querySelector(".vue-data-ui-svg-caret");e&&u.value.removeChild(e);const a=(n=p.value)==null?void 0:n.children;let t=!1;if(a&&a.length===1){const r=a[0].textContent;t=!r||r==="​"}l||t?p.value&&u.value.contains(p.value)&&u.value.removeChild(p.value):p.value&&u.value.contains(p.value)&&b.value.push(p.value),K.value=!1,p.value=null,N.value=[""],F.value={row:0,col:0}}const k=fe(()=>we(o.color,.6));function te(){if(!u.value)return;const l=u.value.querySelector(".vue-data-ui-mask");if(l&&u.value.removeChild(l),o.active){const e=document.createElementNS("http://www.w3.org/2000/svg","rect");e.setAttribute("class","vue-data-ui-mask"),e.setAttribute("width","100%"),e.setAttribute("height","100%"),e.setAttribute("fill","transparent"),e.setAttribute("pointer-events","all"),u.value.insertBefore(e,u.value.firstChild)}}function I(l){var n;const e=o.svgRef;if(!e)return{x:0,y:0};const a=e.createSVGPoint();a.x=l.clientX,a.y=l.clientY;const t=(n=e.getScreenCTM())==null?void 0:n.inverse();return t?a.matrixTransform(t):{x:0,y:0}}function se(l){const e=l.trim().split(/\s+/);if(e.length<4)return l;const a=e.slice(1).map(Number);if(a.length%2!==0)return l;const t=ie(a),n=["M ".concat(t[0]," ").concat(t[1])];for(let v=2;v<t.length-2;v+=2){const f=t[v-2],i=t[v-1],g=t[v],m=t[v+1],x=(f+g)/2,w=(i+m)/2;n.push("Q ".concat(f," ").concat(i," ").concat(x," ").concat(w))}const r=t[t.length-2],s=t[t.length-1];return n.push("L ".concat(r," ").concat(s)),n.join(" ")}function ie(l,e=1){const a=[...l];for(let t=2;t<l.length-2;t+=2){const n=l[t],r=l[t+1],s=l[t-2],v=l[t-1],f=l[t+2],i=l[t+3];a[t]=n+e*((s+f)/2-n),a[t+1]=r+e*((v+i)/2-r)}return a}function ve(l){const e=l.trim().split(/\s+/);let a="",t="",n=null,r=null;for(let s=0;s<e.length;s+=1){const v=e[s];if(isNaN(v)){if(t=v,t==="M"||t==="L")n=parseFloat(e[++s]),r=parseFloat(e[++s]),a+="".concat(t).concat(n," ").concat(r);else if(t==="Q"){const f=parseFloat(e[++s]),i=parseFloat(e[++s]),g=parseFloat(e[++s]),m=parseFloat(e[++s]);f===n&&i===r?a+="t".concat(g-n," ").concat(m-r):a+="q".concat(f-n," ").concat(i-r," ").concat(g-n," ").concat(m-r),n=g,r=m}}else{const f=parseFloat(v),i=parseFloat(e[++s]);if(t==="L"){const g=f-n,m=i-r;g===0?a+="v".concat(m):m===0?a+="h".concat(g):a+="l".concat(g," ").concat(m),n=f,r=i}else if(t==="Q"){const g=f,m=i,x=parseFloat(e[++s]),w=parseFloat(e[++s]);g===n&&m===r?a+="t".concat(x-n," ").concat(w-r):a+="q".concat(g-n," ").concat(m-r," ").concat(x-n," ").concat(w-r),n=x,r=w}}}return a}function U(l){if(h.value!=="draw"||!o.active||!u.value)return;M.value=!0;const{x:e,y:a}=I(l);V.value={x:e,y:a},D.value="M ".concat(e," ").concat(a),A.value=document.createElementNS("http://www.w3.org/2000/svg","path"),A.value.setAttribute("stroke",L.value),A.value.setAttribute("stroke-width",$.value*o.scale),A.value.setAttribute("fill","none"),A.value.setAttribute("stroke-linecap","round"),A.value.setAttribute("stroke-linejoin","round"),A.value.setAttribute("class","vue-data-ui-doodle"),u.value.appendChild(A.value)}function G(l){if(!M.value||!u.value||!A.value)return;const{x:e,y:a}=I(l);D.value+=" ".concat(e," ").concat(a),A.value.setAttribute("d",D.value)}function R(l){if(M.value&&u.value&&A.value){const{x:e,y:a}=I(l);if(V.value&&V.value.x===e&&V.value.y===a){const t=document.createElementNS("http://www.w3.org/2000/svg","circle");t.setAttribute("cx",e),t.setAttribute("cy",a),t.setAttribute("r",$.value*o.scale/2),t.setAttribute("fill",L.value),t.setAttribute("class","vue-data-ui-doodle"),u.value.appendChild(t),b.value.push(t)}else{const t=A.value;t.setAttribute("d",ve(se(D.value))),b.value.push(t)}E.value=[],A.value=""}M.value=!1}function ce(){if(b.value.length>0){const l=b.value.pop();E.value.push(l),u.value&&u.value.removeChild(l)}}function de(){if(E.value.length>0){const l=E.value.pop();b.value.push(l),u.value&&u.value.appendChild(l)}}function pe(){u.value&&(u.value.innerHTML=""),b.value=[],E.value=[],te()}O(h,()=>{o.active&&(T(),ae(),h.value==="text"?u.value.style.cursor="text":u.value.style.cursor=W.value)});function ae(){!o.svgRef||!o.active||(h.value==="draw"?(o.svgRef.addEventListener("mousedown",U),o.svgRef.addEventListener("mousemove",G),o.svgRef.addEventListener("mouseup",R),o.svgRef.addEventListener("mouseleave",R),o.svgRef.addEventListener("touchstart",U,{passive:!1}),o.svgRef.addEventListener("touchmove",G,{passive:!1}),o.svgRef.addEventListener("touchend",R)):h.value==="text"&&o.svgRef.addEventListener("mousedown",z),u.value&&(u.value.style.pointerEvents="auto"))}function T(){o.svgRef&&(o.svgRef.removeEventListener("mousedown",U),o.svgRef.removeEventListener("mousemove",G),o.svgRef.removeEventListener("mouseup",R),o.svgRef.removeEventListener("mouseleave",R),o.svgRef.removeEventListener("touchstart",U),o.svgRef.removeEventListener("touchmove",G),o.svgRef.removeEventListener("touchend",R),o.svgRef.removeEventListener("mousedown",z),u.value&&(u.value.style.pointerEvents="none"))}return O(()=>o.active,l=>{l?ae():T()}),O(()=>o.active,()=>{le(()=>{te()})}),ge(()=>{le(()=>{o.svgRef&&(u.value=document.createElementNS("http://www.w3.org/2000/svg","g"),u.value.setAttribute("class","vue-data-ui-doodles"),u.value.style.cursor=W.value,o.svgRef.appendChild(u.value),T())})}),me(()=>{u.value&&o.svgRef&&(u.value.remove(),T())}),(l,e)=>d.active?(J(),P("div",{key:0,"data-dom-to-png-ignore":"",class:"vue-ui-pen-and-paper-actions",style:y({backgroundColor:d.backgroundColor})},[C("button",{class:"vue-ui-pen-and-paper-action",onClick:e[0]||(e[0]=a=>re("close")),style:y({backgroundColor:d.backgroundColor,border:"1px solid ".concat(k.value)})},[S(Q,{name:"close",stroke:d.color},null,8,["stroke"])],4),C("button",ke,[S(ye,{value:L.value,"onUpdate:value":e[1]||(e[1]=a=>L.value=a),backgroundColor:d.backgroundColor,buttonBorderColor:k.value},null,8,["value","backgroundColor","buttonBorderColor"])]),C("button",{class:H(["vue-ui-pen-and-paper-action",{"vue-ui-pen-and-paper-action-active":h.value==="text"}]),onClick:e[2]||(e[2]=a=>h.value=h.value==="text"?"draw":"text"),style:y({backgroundColor:d.backgroundColor,border:"1px solid ".concat(k.value)})},[S(Q,{name:h.value==="draw"?"annotator":"text",stroke:d.color},null,8,["name","stroke"]),C("div",{style:y({position:"absolute",bottom:"-20px",color:k.value,width:"100%",textAlign:"center",fontSize:"12px",fontVariantNumeric:"tabular-nums"})},Ae(he(be)({v:h.value==="draw"?$.value:B.value,s:"px",r:1})),5)],6),C("button",{class:H(["vue-ui-pen-and-paper-action",{"vue-ui-pen-and-paper-action-disabled":!b.value.length}]),disabled:!b.value.length,onClick:ce,style:y({backgroundColor:d.backgroundColor,border:"1px solid ".concat(k.value),marginTop:"20px"})},[S(Q,{name:"restart",stroke:d.color},null,8,["stroke"])],14,xe),C("button",{class:H(["vue-ui-pen-and-paper-action",{"vue-ui-pen-and-paper-action-disabled":!E.value.length}]),onClick:de,style:y({backgroundColor:d.backgroundColor,border:"1px solid ".concat(k.value)})},[S(Q,{name:"restart",stroke:d.color,style:{transform:"scaleX(-1)"}},null,8,["stroke"])],6),C("button",{class:H(["vue-ui-pen-and-paper-action",{"vue-ui-pen-and-paper-action-disabled":!b.value.length}]),onClick:pe,style:y({backgroundColor:d.backgroundColor,border:"1px solid ".concat(k.value)})},[S(Q,{name:"trash",stroke:d.color},null,8,["stroke"])],6),h.value==="draw"?ne((J(),P("input",{key:0,ref:"range",type:"range",class:"vertical-range",min:.5,max:12,step:.1,"onUpdate:modelValue":e[3]||(e[3]=a=>$.value=a),style:y({accentColor:d.color})},null,4)),[[ue,$.value]]):j("",!0),h.value==="text"?ne((J(),P("input",{key:1,ref:"range",type:"range",class:"vertical-range",min:3,max:48,step:.1,"onUpdate:modelValue":e[4]||(e[4]=a=>B.value=a),style:y({accentColor:d.color})},null,4)),[[ue,B.value]]):j("",!0)],4)):j("",!0)}};export{Se as default};
